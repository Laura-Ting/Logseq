- 第一章 概述
  collapsed:: true
	- 计算机网络在信息时代的作用
	- 因特网概述
	- 三种交换方式
	- 计算机网络的定义和分类
	- 计算机网络的性能指标
	- 计算机网络体系结构
	- 常见体系结构
	  collapsed:: true
		- 分层必要性
		- 分层思想举例
		- 专用术语
- ![Chapter 6 Link Layer and LANs 2023.pdf](../assets/Chapter_6_Link_Layer_and_LANs_2023_1702453817162_0.pdf)
- 第三章 数据链路层
  collapsed:: true
	- 概述
	  collapsed:: true
		- 概念
		  collapsed:: true
			- **链路**(Link) 就是从一个结点到相邻结点的一段物理线路，而中间没有任何其他的交换结点。
			- **数据链路**(Data Link)是指把实现通信协议的**硬件和软件**加到链路上,就构成了数据链路。
			- 数据链路层以**帧**为单位传输和处理数据。
			- 网络中的**主机、路由器、交换机**等都**必须实现**数据链路层
			- 不同的链路层可能采用不同的数据链路层协议
		- 使用点对点信道的数据链路层的3个重要问题
		  collapsed:: true
			- 封装成帧
			  collapsed:: true
				- 添加**帧头**和**帧尾**
				  collapsed:: true
					- ![](https://api2.mubu.com/v3/document_image/d8af6270-b3ee-440b-9c2a-7619b28eed36-27042929.jpg)
			- 差错检测
			  collapsed:: true
				- **检错码**，封装在**帧尾**，判断帧在传输过程中出现误码
			- 可靠传输
			  collapsed:: true
				- 尽管误码是不能完全避免的，但若能**实现发送方发送什么，接收方就能收到什么**，就称为**可靠传输**。
		- 使用广播信道的数据链路层
		  collapsed:: true
			- 编址：确定帧是发给谁的，要不要接收
			- 碰撞：
			  collapsed:: true
				- 共享式局域网以太网的媒体接入控制协议CSMA/CD
				- 802.11局域网的媒体接入控制协议CSMA/CA
	- 封装成帧
	  collapsed:: true
		- **封装成帧**是指数据链路层给上层交付的协议数据单元**添加帧头和帧尾**使之成为帧。
		  collapsed:: true
			- 帧头和帧尾中包含有重要的**控制信息**。
			- 帧头和帧尾的作用之一就是**帧定界**（帧同步），用于**从比特流中提取出帧**
			  collapsed:: true
				- PPP帧：帧定界标志（帧头和帧尾都有），01111110
				- 以太网V2的MAC帧：8个字节的前导码（物理层添加）
				  collapsed:: true
					- 前同步码：前7个字节，使接收方的时钟同步
					- 帧开始定界符：第八个字节，其后面紧跟着的就是MAC帧
					- 帧间间隔：96比特时间，所以不需要帧结束定界符
		- **透明传输**是指数据链**路层对上层交付的传输数据没有任何限制**，就好像数据链路层不存在一样。
		  collapsed:: true
			- 字节计数法（ Byte count）
			  collapsed:: true
				- 在帧头中用一个域来表示整个帧的字符个数
				- 缺点：若计数出错，对本帧和后面的帧有影响
			- 面向字节的物理链路使用字节填充(或称字符填充)
			  collapsed:: true
				- 首部定界符SOH(Start Of Header)，尾部定界符EOT(End Of Transmission)
				- 数据包含帧定界符时
				  collapsed:: true
					- 在发送帧之前，对帧的数据部分进行扫描
					- 每出现一个帧定界符就在其前面插入一个转义字符ESC
					- 注意：转义字符是一种特殊的控制字符，长度为1个字节，十进制值为27，而并不是E，S，C三个字符
					- 提取帧时，遇到第一个帧定界符时，认为这是帧的开始。当遇到转义字符时就知道，其后面的1字节内容虽然与帧定界符相同，但它是数据而不是定界符，剔除转义字符后将其后面的内容作为数据继续提取，当再次提取到帧定界符时表明这是帧的结束
				- 数据包含帧定界符和ESC，则在ESC前面也添加ESC
			- 面向比特的物理链路使用比特填充
			  collapsed:: true
				- 数据包含帧定界符时：每五个连续的1后插入0
			- 物理层编码违例
			  collapsed:: true
				- 核心思想：选择的定界符不会在数据部分出现
				- 前导码
				  collapsed:: true
					- 存在很长的 前导码（preamble），可以用作定界符
					- 例如：传统以太网、802.11
				- 曼切斯特编码 / 差分曼切斯特编码
				  collapsed:: true
					- 正常的信号在周期中间有跳变，持续的高电平（或低电平）为违例码，可以用作定界符
					- 例如：802.5令牌环网
		- 注意
		  collapsed:: true
			- 为了提高帧的传输效率，应当使帧的数据部分的长度尽可能大些，即真的数据部分应该远大于帧头和帧尾
			- 考虑到差错控制等多种因素，每一种数据链路层协议都规定了**帧的数据部分的长度上限**，即**最大传送单元MTU**(Maximum Transfer Unit)。
	- 差错检测
	  collapsed:: true
		- 介绍
		  collapsed:: true
			- 实际的通信链路都不是理想的，比特在传输过程中可能会产生差错: 1可能会变成0,而0也可能变成1。这称为**比特差错**。
			- 在一段时间内，**传输错误的比特占所传输比特总数的比率**称为**误码率BER**(Bit Error Rate)。
			- 使用差错检测码来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一。
			- EDC（error detection and correction bits）
			  collapsed:: true
				- EDC=差错检测和纠正位（冗余位）
				  D =数据由差错检测保护，可以包含头部字段
				- FCS是EDC的一种实现
				  collapsed:: true
					- FCS帧检验序列（Frame Check Sequence）
					  collapsed:: true
						- ![](https://api2.mubu.com/v3/document_image/d7232e3b-c3dc-4eac-b1cf-930ca3ebd59e-27042929.jpg)
		- 奇偶校验
		  collapsed:: true
			- 一维奇偶校验
			  collapsed:: true
				- 在待发送的数据后面添加1位奇偶校验位,使整个数据(包括所添加的校验位在内)中“1"的个数为奇数(奇校验)或偶数(偶校验)。
				  collapsed:: true
					- 如果有奇数个位发生误码，则奇偶性发生变化，可以检查出误码;
					- 如果有偶数个位发生误码，则奇偶性不发生变化,不能检查出误码(漏检) ;
				- 检测单个bit级错误
			- 二维奇偶校验
			  collapsed:: true
				- 行+列
				- 检测和**纠正**单个bit错误
		- 循环冗余校验CRC(Cyclic Redundancy Check)
		  collapsed:: true
			- 收发双方约定好一个生成多项式G(x);
			- 发送方基于待发送的数据和生成多项式计算出差错检测码(冗余码)，将其添加到待传输数据的后面一起传输;
			- 接收方通过生成多项式来计算收到的数据是否产生了误码;
			- 处理
			  collapsed:: true
				- ![](https://api2.mubu.com/v3/document_image/e7d338fd-d0fe-4dba-9143-3a6f972bd630-27042929.jpg)
			- 例子
			  collapsed:: true
				- ![](https://api2.mubu.com/v3/document_image/7a300923-4e45-4e91-9d63-e73705bcbc65-27042929.jpg)
		- 检错与纠错
		  collapsed:: true
			- 检错码只能检测出帧在传输过程中出现了差错，但并不能定位错误，因此无法纠正错误。
			- 要想纠正传输中的差错，可以使用冗余信息更多的纠错码进行前向纠错。但纠错码的开销比较大，在计算机网络中较少使用。
			- 循环冗余校验CRC有很好的检错能力(漏检率非常低)，虽然计算比较复杂，但非常易于用硬件实现，因此被广泛应用于数据链路层。
			- 在计算机网络中通常采用我们后续课程中将要讨论的检错重传方式来纠正传输中的差错,或者仅仅是丢弃检测到差错的帧，这取决于数据链路层向其上层提供的是可靠传输服务还是不可靠传输服务。
	- 可靠传输
	  collapsed:: true
		- 基本概念
		- 实现机制
		  collapsed:: true
			- 停止等待协议
			- 回退N帧协议
			- 选择重传协议
	- 媒体接入控制MAC(Medium Access Control)
	  collapsed:: true
		- 基本概念
		  collapsed:: true
			- 介绍
			  collapsed:: true
				- 共享信道要着重考虑的一个问题就是如何协调多个发送和接收站点对一个共享传输媒体的占用
			- 分类
			  collapsed:: true
				- 划分信道
				  collapsed:: true
					- 特点
					  collapsed:: true
						- 预先固定分配好信道。这类方法非常不灵活。对于突发性数据传输信道利用率会很低。
						- 通常在无线网络的物理层中使用，而不是在数据链路层中使用。
					- 分类
					  collapsed:: true
						- 频分多址
						- 时分多址
						- 码分多址
				- 随机接入
				  collapsed:: true
					- 所有站点通过**竞争**， **随机**地在信道上发送数据，如果怡巧有两个或更多的站点在同一时刻发送数据，则信在共享媒体上就要产生碰撞(即发生了冲实)出使得这些站点的发送都失败。
					- 因此，这类协议要解决的关键问题是如何尽量避免冲突及在发生冲突后如何尽使恢复通信。
					- 著名的共享式以太同采用的就是随机接入。
				- 轮询协议
				  collapsed:: true
					- 集中控制
					  collapsed:: true
						- 有一个**主站**以循环方式**轮询**每介站点有无数据发送。只有被轮询到的站点才能发送数据。
						- 缺点
						  collapsed:: true
							- 轮询开销：轮询本身消信道带宽
							- 等待时间：每个节点需等到主节点轮询后开始传输，即使只有一个节点，也需要等到轮询一周后才能够发送
							- 单点故障：主节点失效时造成整个系统无法工作
					- 分散控制（令牌传递）
					  collapsed:: true
						- 各站点是平等的。并连接成一个**环形网络**。**令牌**(一个特殊的控制帧)沿环连站传递。接收到令牌的站点才有权发送数据，并在发送完数据后将令牌传递给下一个站点。
				- 有限争用协议
				  collapsed:: true
					- 随机访问协议在轻负载时延迟特性好，在重负载时信道效率低
					- 轮询协议在轻负载时延迟特性差，但在重负载时信道效率高
					- 基本思想
					  collapsed:: true
						- 将站进行分组，每个竞争时间片中只允许某个组的站进行竞争
						- 有两种极端情况，如果每组只有一个站，就是无冲突协议；如果所有站都在同一个组中，这就是争用协议
						- 有限争用协议就是要根据当前网络的负载情况，对站进行动态的分组，当网络负载较轻时，每组的站数多一点，当网络负载较重时，每组的站数就少一点
						- 轻负载下使用竞争，重负载下使用无冲突方法
					- 适应树搜索协议
			- 使用
			  collapsed:: true
				- 随着技术的发展，交换技术的成熟和成本的降低，具有更高性能的使用点对点链路和链路层交换机的交换式局域网在有线领域已完全取代了 共享式局域网
				- 但由于无线信道的广播天性，无线局域网仍然使用的是共享媒体技术。
		- 静态信道划分
		  collapsed:: true
			- 信道复用
			  collapsed:: true
				- 复用(Multiplexing) 就是通过一条物理线路同时传输多路用户的信号。
				- 当网络中传输媒体的传输容量大于多条单一信道传输的总通信量时，可利用复用技术在一条物理线路上建立多条通信信道来充分利用传输媒体的带宽。
			- 信道复用技术
			  collapsed:: true
				- 频分复用FDM
				  collapsed:: true
					- 过程
					  collapsed:: true
						- 将传输线路的频带资源划分成多个子频带，形成多个子信道，各子信道之间需要留出隔离频带，以免造成子信道间的干扰。
						- 当多路信导输入一个多路复用器时，这个复用器将每-路信导调制到不同频率的载波上。
						- 接收端由相应的分用器通过滤波将各路信号分开，将合成的复用信导恢复成原始的多路信导。
					- 特点
					  collapsed:: true
						- 频分复用的所有用户同时占用不同的频带资源并行通信。
						  collapsed:: true
							- ![](https://api2.mubu.com/v3/document_image/5810f671-e50b-4a0d-b392-0e067e69f289-27042929.jpg)
						- 分配给站点的频段如果没有被使用，则空闲
				- 时分复用TDM
				  collapsed:: true
					- 过程
						- 时分复用技术将传输线路的带宽资源按**时隙**轮流分配给不同的用户，每对用户只在所分配的时隙里使用线路传输数据。
						- 时分复用技术将时间划分成了一段段等长的时分复用帧，每一个时分复用的用户在每-个时分复用帧中占用固定序号的时隙。
						- 每一个用户所占用的时隙是周期性出现的，其周期就是时分复用帧的长度
					- 特点
						- 时分复用的所有用户在不同的时间占用同样的频带宽度。
						- 如果站点无帧传输，时隙空闲->浪费
						- ![](https://api2.mubu.com/v3/document_image/daea5d93-9169-4cab-b3fb-9d7377e3229f-27042929.jpg)
				- 波分复用WDM
				  collapsed:: true
					- 光的频分复用
					  collapsed:: true
						- ![](https://api2.mubu.com/v3/document_image/7afa6a6a-c09c-4002-9462-31d1f4ae976b-27042929.jpg)
				- 码分复用CDM
				  collapsed:: true
					- 复用与多址
					  collapsed:: true
						- 码分复用CDM是另一种共享信道的方法。实际上，由于该技术主要用于多址接入，人们更常用的名词是码分多址CDMA(Code Division Multiple Access)。
						- 同理，频分复用FDM和时分复用TDM同样可用于多址接入,相应的名词是频分多址FDMA(Frequency Division Multiple Access)和时分多址TDMA(Time Division Multiple Access)。
						- 不严格区分复用与多址的概念
						  collapsed:: true
							- 复用是将单一媒体的频带资源划分成很多子信道，这些子信道之间相互独立，互不干扰。从媒体的整体频带资源上看，每个子信道只占用该媒体频带资源的一部分。
							- 多址(更确切地应该称为多点接入)处理的是动态分配信道给用户。这在用户仅仅暂时性地占用信道的应用中是必须的，而所有的移动通信系统基本上都属于这种情况。相反，在信道永久性地分配给用户的应用中，多址是不需要的(对于无线广播或电视广播站就是这样)。
							- 某种程度上，FDMA、TDMA. CDMA可以分别看成是FDM、TDM、CDM的应用。
					- 概念
					  collapsed:: true
						- 与FDM和TDM不同，CDM的每一个用户可以在**同样的时间使用同样的频带进行通信**。
						- 由于各用户使用经过特殊挑选的不同码型，因此各用户之间不会造成干扰。
						- CDM最初是用于军事通信的，因为这种系统所发送的信号有很强的抗干扰能力，其频谱类似于白噪声,不易被敌人发现。
						- 随着技术的进步，CDMA设备的价格和体积都大幅度下降，因而现在已广泛用于民用的移动通信中。
					- CDMA
					  collapsed:: true
						- 码片
						  collapsed:: true
							- 在CDMA中，每一个比特时间再划分为m个短的间隔，称为码片(Chip) 。通常m的值是64或128。为了简单起见，在后续的举例中，我们假设m为8。
						- m bit码片序列
						  collapsed:: true
							- 使用CDMA的每一个站被指派一个唯一的m bit码片序列(Chip Sequence)。
								- 一个站如果要发送比特1,则发送它自己的m bit码片序列;
								- 一个站如果要发送比特0,则发送它自己的m bit码片序列的二进制反码;
								- 直接序列扩频DSSS：1用+1代替，0用-1代替
						- 码片序列的挑选原则
						  collapsed:: true
							- 分配给每个站的码片序列必须各不相同，实际常采用伪随机码序列。
							- 分配给每个站的码片序列必须相互正交(规格化内积为0)。
							  collapsed:: true
								- 令向量S表示站S的码片序列，令向量T表示其他任何站的码片序列。
								- 两个不同站S和T的码片序列正交，就是向量S和T的规格化内积为0: S·T= 0 S·^T= 0 S·S= I S·^S=-1
							- eg：
							  collapsed:: true
								- ![](https://api2.mubu.com/v3/document_image/f88c80a6-a3bf-4ccd-ba83-6bae0c0ba22a-27042929.jpg)
						- 应用
						  collapsed:: true
							- ![](https://api2.mubu.com/v3/document_image/3e009605-076f-47b3-aab7-57f5bca23004-27042929.jpg)
		- 随机接入
		  collapsed:: true
			- ALOHA
			  collapsed:: true
				- 纯ALOHA
				  collapsed:: true
					- 特点
					  collapsed:: true
						- 无时隙ALOHA：简单、无须节点间在时间上同步
						- 当有帧需要传输：马上传输
					- 冲突的概率：
					  collapsed:: true
						- 帧在t0发送，和其它在[t0-1, t0+1]区间内开始发送的帧冲突
						- p . (1-p)2^(N-1)
					- 效率：18%
				- 时隙ALOHA
				  collapsed:: true
					- 特点
					  collapsed:: true
						- 节点只在时隙开始时发送帧
						- 传输时没有检测到冲突，成功
							- 节点能够在下一时隙发送新帧
						- 检测时如果检测到冲突，失败
							- 节点在每一个随后的时隙以概率p重传帧直到成功
					- 优点
					  collapsed:: true
						- 节点可以以信道带宽全速连续传输
						- 高度分布：仅需要节点之间在时隙上的同步
						- 简单
					- 缺点
					  collapsed:: true
						- 存在冲突，浪费时隙
						- 即使有帧要发送，仍然有可能存在空闲的时隙
						- 节点检测冲突的时间<帧传输的时间：必须传完
						- 需要时钟上同步
					- 效率
					  collapsed:: true
						- f(p*)=Np*(1-p*)^N-1
						- 信道利用率最高37%
			- CSMA
			  collapsed:: true
				- 1坚持型CSMA
				  collapsed:: true
					- 原理
					  collapsed:: true
						- 若站点有数据发送，先监听信道；
						- 若站点发现信道空闲，则发送；
						- 若信道忙，则继续监听直至发现信道空闲，然后完成发送；
						- 若产生冲突，等待一随机时间，然后重新开始发送过程。
					- 优点：减少了信道空闲时间；
					- 缺点：增加了发生冲突的概率；
					- 广播延迟对协议性能的影响：广播延迟越大，发生冲突的可能性越大，协议性能越差；
				- 非坚持型
				  collapsed:: true
					- 原理
					  collapsed:: true
						- 若站点有数据发送，先监听信道；
						- 若站点发现信道空闲，则发送
						- 若信道忙，等待一随机时间，然后重新开始发送过程；（而非一直监听，一有空闲立刻发送）
						- 若产生冲突，等待一随机时间，然后重新开始发送过程。
					- 优点：减少了冲突的概率；
					- 缺点：增加了信道空闲时间，数据发送延迟增大；
					- 信道效率比 1-坚持CSMA高，传输延迟比 1-坚持CSMA大
				- p坚持型CSMA
				  collapsed:: true
					- 适用于时间单元信道
					- 原理
					  collapsed:: true
						- 若站点有数据发送，先监听信道；
						- 若站点发现信道空闲，则以概率p发送数据，以(1–p)的概率延迟一个时间单元发送。若下一个时间单元仍空闲，重复此过程，直至数据发出或时槽被其他站点所占用；
						- 若信道忙，则等待下一个时间单元，重新开始发送；
						- 若产生冲突，等待一随机时间，然后重新开始发送
					- 对比图
					  collapsed:: true
						- ![Replaced by Image Uploader](https://raw.githubusercontent.com/qugushihua/blog-images/master/202312131723543.png)
			- CSMA/CD协议
			  collapsed:: true
				- 载波监听多址接入/碰撞检测
				  collapsed:: true
					- 多址接入MA
					  collapsed:: true
						- 多个站连接在一条总线上, 竞争使用总线。
					- 载波监听CS
					  collapsed:: true
						- 每一个站在发送帧之前先要检测一下总线.上是否有其他站点在发送帧(“先听后说" )
							- 若检测到总线空闲96比特时间，则发送这个帧;
							- 若检测到总线忙，则继续检测并等待总线转为空闲96比特时间，然后发送这个帧。
					- 碰撞检测CD
					  collapsed:: true
						- 每一个 正在发送帧的站边发送边检测碰撞(“边说边听”) :
						  collapsed:: true
							- 一旦发现总线上出现碰撞，则立即停止发送，退避一段随机时间后再次发送(“一旦冲突，立即停说，等待时机，重新再说”)。
						- 以太网还采取一种叫做**强化碰撞**的措施。
						  collapsed:: true
							- 当发送帧的站点一旦检测到碰撞，除了立即停止发送帧外，还要再继续发送32比特或48比特的人为干扰信号(Jamming Signal) ,以便有足够多的碰撞信号使所有站点都能检测出碰撞。
				- 争用期（碰撞窗口）
				  collapsed:: true
					- 主机最多经过2τ(即δ→0 )的时长就可检测到本次发送是否遭受了碰撞
					- 因此，以太网的**端到端往返传播时延2τ**称为**争用期**或**碰撞窗口**
					- 经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。
					  collapsed:: true
						- ![](https://api2.mubu.com/v3/document_image/e95e3e3e-4e02-443c-a917-81a8a259e334-27042929.jpg)
					- 每一个主机在自己发送帧之后的一小段时间内,存在着遭遇碰撞的可能性。这一小段时间是不确定的。它取决于另一个发送帧的主机到本主机的距离，但不会超过总线的端到端往返传播时延,即一个争用期时间。
					- 显然，在以太网中发送帧的主机越多，端到端往返传播时延越大，发生碰撞的概率就越大。因此,共享式以太网不能连接太多的主机，使用的总线也不能太长。
					  collapsed:: true
						- 10Mb/以太网把争用期定为512比特发送时间,即51.2μs, 因此其总线长度不能超过5120m,但考虑到其他一些因素如信号衰减等，以太网规定总线长度不能超过2500m.
				- 最小帧长
				  collapsed:: true
					- **最小帧长=争用期 * 数据传输速率=2τ * 数据传输速率**
					- 以太网规定最小帧长为64字节，即512比特(512比特时间即为争用期) ;
					  collapsed:: true
						- 如果要发送的数据非常少,那么必须加入一些填充字节,使帧长不小于64字节。
					- 以太网的最小帧长确保了主机可在帧发送完成之前就检测到该帧的发送过程中是否遭遇了碰撞;
					  collapsed:: true
						- 如果在争用期(共发送64字节)没有检测到碰撞,那么后续发送的数据就一定不会发生碰撞;
						- 如果在争用期内检测到碰撞，就立即中止发送，这时已经发送出去的数据一定小于64字节
						- 凡长度小于64字节的帧都是由于碰撞而异常中止的无效帧。
				- 最大帧长
				  collapsed:: true
					- 帧很长的话，总线一直忙，其他主机没办法发送，而接收这个帧的主机缓冲区也面临溢出
					- 规定最大帧长
					  collapsed:: true
						- ![](https://api2.mubu.com/v3/document_image/2476a9e9-4497-4899-bfbc-1b35b1b1d12f-27042929.jpg){:height 164, :width 598}
				- 截断二进制指数退避算法
				  collapsed:: true
					- 退避时间=基本退避时间 * 随机数r
						- 基本退避时间：争用期2τ .
						- 随机数r：r从离散的整数集合{0, 1, ... (2^k- 1)}中随机选出一个数，k = Min[重传次数，10]
					- 若连续多次发生碰撞，就表明可能有较多的主机参与竞争信道。但使用上述退避算法可**使重传需要推迟的平均时间随重传次数而增大**(这也称为**动态退避**)，因而减小发生碰撞的概率，有利于整个系统的稳定。
					- 当**重传达16次**仍不能成功时，表明同时打算发送帧的主机太多，以至于连续发生碰撞，则**丢弃该帧**，并向高层报告。
				- 信道利用率
				  collapsed:: true
					- 理想情况
					  collapsed:: true
						- 各主机发送帧都不会产生碰撞;
						- 总线一旦空闲就有某个主机立即发送帧;
					- 发送一帧占用总线的时间为T0 + τ,而帧本身的发送时间是T0,
					  collapsed:: true
						- 极限信道利用率
						  collapsed:: true
							- ![](https://api2.mubu.com/v3/document_image/92e3ae97-5165-4196-9373-166c14edbba8-27042929.jpg){:height 119, :width 593}
						- 图示
						  collapsed:: true
							- ![](https://api2.mubu.com/v3/document_image/0f7d7cab-949e-4b95-b1e6-84fbac95ab36-27042929.jpg)
				- 帧发送流程
					- ![](https://api2.mubu.com/v3/document_image/2bbe2e90-7b2d-451d-a960-8c233fdeeaa3-27042929.jpg)
				- 帧接收流程
				  collapsed:: true
					- ![](https://api2.mubu.com/v3/document_image/5125e596-d269-4e88-98ad-1d08a6fa762f-27042929.jpg)
	- MAC地址，IP地址，ARP协议
	  collapsed:: true
		- 介绍
		  collapsed:: true
			- 数据链路层
			  collapsed:: true
				- MAC地址是以太网的MAC子层所使用的地址;
			- 网际层
			  collapsed:: true
				- IP地址是TCP/IP体系结构网际层所使用的地址;
				- ARP协议属于TCP/IP体系结构的网际层，其作用是已知设备所分配到的IP地址，使用ARP协议可以通过该IP地址获取到设备的MAC地址;
				- 尽管IP地址和ARP协议属于TCP/IP体系结构的网际层（而不属于数据链路层)，但是它们与MAC地址存在一定的关系，并且我们日常的网络应用都离不开MAC地址、IP地址以及ARP协议。因此，我们将这三者放在一起讨论。
		- MAC地址（属于数据链路层）
		  collapsed:: true
			- 使用点对点信道的数据链路层不需要使用地址
			- 使用广播信道的数据链路层必须使用地址来区分各主机
			  collapsed:: true
				- 当多个主机连接在同一个广播信道上，要想实现两个主机之间的通信，则每个主机都必须有一个唯一的标识，即一个**数据链路层地址**;
				  id:: 65795dc6-0e6f-4066-b308-24f5aa7e601d
				- 在每个主机发送的**帧中必须携带标识发送主机和接收主机的地址**。由于这类地址是用于媒体接入控制MAC(Media Access Control)，因此这类地址被称为**MAC地址**;
				  collapsed:: true
					- MAC地址一般被固化在网卡(网络适配器）的电可擦可编程只读存储器EEPROM中，因此MAC地址也被称为**硬件地址**;
					- MAC地址有时也被称为**物理地址**。
					- 请注意:这并不意味着MAC地址属于网络体系结构中的物理层!
				- 一般情况下，用户主机会包含两个网络适配器:有线局域网适配器（有线网卡）和无线局域网适配器（无线网卡)。每个网络适配器都有一个全球唯一的MAC地址。而交换机和路由器往往拥有更多的网络接口，所以会拥有更多的MAC地址。综上所述，严格来说，**MAC地址是对网络上各接口的唯一标识**，而不是对网络上各设备的唯一标识。
			- MAC地址格式
			  collapsed:: true
				- 扩展的唯一标识符EUI-48=组织唯一标识符OUI+网络接口标识符（厂商自行分配）
				  collapsed:: true
					- 48个bits，6个字节，每个字节用2位16进制表示
					  collapsed:: true
						- 标准表示法，用于windows：00-0F-CF-93-8C-92
						- 其他表示法，用于linux，apple，android：00:0C:CF:93:8C:92，packet tracer：000C.CF93.8C92
				- 四种MAC地址
				  collapsed:: true
					- 第一字节的b0，b1位
					  collapsed:: true
						- 第一字节的b0位为0时表示单播，为1时表示多播
						- 第一字节的b1位为0时表示全球管理，为1时表示本地管理
					- b1b0=00全球管理单播地址
					  collapsed:: true
						- 厂商生产网络设备（网卡，交接机，路由器）时固化
					- b1b0=01全球管理多播地址
					  collapsed:: true
						- 标准网络设备所支持的多播地址,用于特定功能
					- b1b0=10本地管理单播地址
					  collapsed:: true
						- 由网络管理员分配覆盖网络接口的全球管理单播地址
					- b1b0=11本地管理多播地址
					  collapsed:: true
						- 用户对主机进行配置,以表明属属于哪些多播组
						- 注意:余46位全为1时,就是广指地起FF-FF-F-FF-FF-FF
					- 四种地址数量占比均为1/4
			- MAC地址发送顺序
			  collapsed:: true
				- 字节发送顺序：第一字节->第六字节
				- 字节内的比特发送顺序：b0->b7
			- 单播MAC地址
			  collapsed:: true
				- 构建单播帧：源地址填入自己MAC地址，目的地址填入目的MAC地址
				- 比较该单播帧的目的MAC地址和自己的MAC地址
				  collapsed:: true
					- 匹配则递交给上层
					- 不匹配则丢弃
			- 广播MAC地址
			  collapsed:: true
				- 构建广播帧：源地址填入自己MAC地址，目的地址填入全F，FF-FF-FF-FF-FF-FF
				- 发现是广播地址，接收，交给上层处理
		- IP地址（属于网络层）
		  collapsed:: true
			- IP地址是因特网(Internet)上的主机和路由器所使用的地址，用于标识两部分信息
			  collapsed:: true
				- 网络编号:标识因特网上数以百万计的网络
				- 主机编号:标识同一网络上不同主机(或路由器各接口)
			- 很显然，之前介绍的MAC地址不具备区分不同网络的功能。
			  collapsed:: true
				- 如果只是一个单独的网络，不接入因特网，可以只使用MAC地址(这不是一般用户的应用方式)。
				- 如果主机所在的网络要接入因特网，则IP地址和MAC地址都需要使用。
		- IP地址与MAC地址
		  collapsed:: true
			- 从网络体系结构看
			  collapsed:: true
				- ![](https://api2.mubu.com/v3/document_image/1568fee0-92a5-42d1-a297-ae95c366b704-27042929.jpg){:height 208, :width 608}
			- 数据包转发过程中
			  collapsed:: true
				- 数据包转发过程中源IP地址和目的IP地址保持不变;
				- 数据包转发过程中源MAC地址和目的MAC地址逐个链路（或逐个网络)改变。
				- 图示
					- ![](https://api2.mubu.com/v3/document_image/283757ec-98c8-48b7-9ccf-b68ce7ce29ad-27042929.jpg)
		- ARP地址解析协议
		  collapsed:: true
			- 作用：通过IP地址找MAC地址
			- ARP高速缓存表
			  collapsed:: true
				- 记录IP地址和MAC地址的对应关系
				- 如果表中不存在对应关系，需要发送ARP请求报文
			- ARP请求报文（广播）与响应报文
				- 请求：封装在MAC帧中，目的地址为FF-FF-FF-FF-FF-FF
				- 发送内容
				  collapsed:: true
					- 发送者IP地址
					- 发送者MAC地址
					- 我想知道IP地址为xxx的主机的MAC地址
				- 接收
				  collapsed:: true
					- 所有主机全接收，交付上层进行解析
					- 如果不是问自己则不用理会，如果是自己需要给出响应
					- 自己在ARP缓存表中记录发送者的IP与MAC对应关系
				- 响应
				  collapsed:: true
					- 响应内容：自己的IP，自己的MAC，目的地址是之前的发送者的MAC
					- 所有主机都接收，与自己有关的记录，与自己无关的丢弃
				- ARP记录
				  collapsed:: true
					- IP地址
					- MAC地址
					- 类型
					  collapsed:: true
						- 静态：手工设置，不同操作系统下的生命周期不同，例如系统重启后不存在或系统重启后依然有效。
						- 动态：自动获取，生命周期默认为两分钟;
				- 注意：
				  collapsed:: true
					- ARP协议只能在一段链路或一个网络上使用，不能跨网络使用，ARP的使用是逐段链路进行的
					- ARP还有其他类型的，eg：用于检查IP地址冲突的无故ARP（免费ARP）
					- ARP协议没有安全验证机制，存在ARP欺骗或攻击
	- 以太网
	  collapsed:: true
		- 经典以太网
		  collapsed:: true
			- 物理层
			  collapsed:: true
				- 最高速率10Mbps
				- 曼彻斯特编码
				- 使用同轴电缆和中继器连接
			- MAC子层协议
			  collapsed:: true
				- CSMA/CD
				- MAC帧格式
					- ![Replaced by Image Uploader](https://raw.githubusercontent.com/qugushihua/blog-images/master/202312131751254.png)
		- 交换式以太网
		  collapsed:: true
			- 使用集线器（HUB）组建以太网
			- 使用Hub扩展以太网
			- 核心是交换机
			- 集线器 vs 交换机
				- ![Replaced by Image Uploader](https://raw.githubusercontent.com/qugushihua/blog-images/master/202312131755543.png)
		- 快速以太网
		  collapsed:: true
			- 带宽 10Mbps->100Mbps
			- 比特时间 100ns -> 10ns
			- 保留原来的工作方式
		- 千兆以太网
		  collapsed:: true
			- 100Mbps -> 1000Mbps( 1Gbps )
			- 保留原来的工作方式
			- 全双工和半双工两种方式工作
			- 流量控制和巨型帧
		- 万兆以太网
		  collapsed:: true
			- 1Gbps -> 10Gbps
			- 只支持全双工，不再使用CSMA/CD
			- 保持兼容性
			- 重点是超高速的物理层
		- 40G-100G以太网
		  collapsed:: true
			- 只支持全双工
			- 保留以太网帧格式和MAC方法
			- 保留当前802.3标准的最小帧和最大帧大小
			- 联网设备可插拔
- ![Chapter 5 Network Control Plane 2023.pdf](../assets/Chapter_5_Network_Control_Plane_2023_1702471142388_0.pdf)
- 第四章 网络层
	- 概述
	- 提供的两种服务
	- IPv4
	  collapsed:: true
		- 概述
		- 分类编址IPv4
		- 划分子网IPv4
		- 无分类编址IPv4
		- IPv4地址的应用规划
	- IP数据报的发送和转发过程
	- 控制平面
		- 路由算法
			- 最优化原则
			- 最短路径路由
			  collapsed:: true
				- Dijkstra算法
					- 特点：
					  collapsed:: true
						- 每个节点都知道当前网络拓扑，链路代价
						  collapsed:: true
							- 通过链路广播完成
							- 所有节点都有相同的信息
						- 计算从源到所有节点的最小代价，给出转发表
						- 迭代：经过k次迭代就知道到k个目的地的最小代价
					- 符号：
					  collapsed:: true
						- c(x, y): 从x到y的链路代价，正无穷则表示这两个节点不直接相连
						- D(v): 从源点到v点的当前代价
						- p(v): 从源到v的路径上的前导节点
						- N': 已知最小代价路径的节点集合
					- 算法：
					  collapsed:: true
						- 代码
						  collapsed:: true
							- ![Replaced by Image Uploader](https://raw.githubusercontent.com/qugushihua/blog-images/master/202312132129295.png)
						- 过程
						  collapsed:: true
							- ![Replaced by Image Uploader](https://raw.githubusercontent.com/qugushihua/blog-images/master/202312132140061.png)
						- 算法复杂度：n个节点
						  collapsed:: true
							- 对于每个节点，算法需要检查所有不在已访问节点集合N中的节点w，总的比较次数是(1+n)*n/2 即O(n^2)
							- 堆数据结构来管理节点的优先级，可以将算法复杂度优化到O(nlogn)
						- 消息复杂度
						  collapsed:: true
							- 每个路由器必须将他的链路状态广播到n个节点
							- 一种高效的广播算法可以通过跨越O(n)个链路来传播来自一个源节点的广播消息
							- 整体n个路由器即O(n^2)
					- 可能的震荡
					  collapsed:: true
						- 链路代价=链路承载的流量，这决定于流量，而流量时常变化
			- 洪泛
			  collapsed:: true
				- 静态路由算法
				- 基本思想
				  collapsed:: true
					- 把收到的每一个包，向除了该包到来的线路外的所有输出线路发送
				- 主要问题
				  collapsed:: true
					- 洪泛要产生大量重复包
				- 解决措施
				  collapsed:: true
					- 每个包头包含站点计数器，每经过一站计数器减1，为0时则丢弃该包
					- 记录包经过的路径
					- 路由器为减少路由规模，记录K值，小于K值则已经接收
					- 选择性洪泛算法
					  collapsed:: true
						- 洪泛法的一种改进。将进来的每个包仅发送到与正确方向接近的线路上
						- 应用情况
						  collapsed:: true
							- 路由器和线路的资源过于浪费，实际很少直接采用
							- 具有极好的健壮性，可用于军事应用
							- 作为衡量标准评价其它路由算法
			- 距离向量
			  collapsed:: true
				- 基于BF等式，动态规划
				  collapsed:: true
					- ![Replaced by Image Uploader](https://raw.githubusercontent.com/qugushihua/blog-images/master/202312132225620.png)
				- 思路
				  collapsed:: true
					- 每个节点都将自己的距离矢量估计值传送给邻居，定时或者DV有变化时，让对方去算
					- 当x从邻居收到DV时，自己运算，更新它自己的距离矢量
					  collapsed:: true
						- ![Replaced by Image Uploader](https://raw.githubusercontent.com/qugushihua/blog-images/master/202312132226094.png)
					- Dx(y)估计值最终收敛于实际的最小代价值dx(y)
					  collapsed:: true
						- 异步式,迭代（本地迭代被触发）
						  collapsed:: true
							- 本地链路代价变化了
							- 从邻居来了DV的更新消息
						- 分布式
						  collapsed:: true
							- 每个节点只是在自己的DV改
							  变之后向邻居通告
						- 等待->重新计算->告知 循环
				- 缺点：好消息传递的快，坏消息传递的慢
				- 保证路由表正确性的六种方法联合使用
				  collapsed:: true
					- 最大度量值
					  collapsed:: true
						- 协议不同，最大度量值也不相同
						- RIP协议的最大度量值是16跳
						- 当路由表中的度量值达到最大度量值时，路由器就会认为这条路由已经失效，将它清除出路由表
					- 水平分割
					  collapsed:: true
						- 从一个方向学来的路由信息，不能再放入发回那个方向的路由更新包，并且又发回那个方向
					- 路由中毒（正向下毒）
					  collapsed:: true
						- 网络出现故障时，通知邻居该网段不可用
						- 但考虑到环形，可能被更新，所以需要反向下毒
					- 毒性反转（反向下毒）
					- 保持时间
					  collapsed:: true
						- 该网段的路由变成“DOWN”状态时，还要在路由器中保留一段时间
					- 触发更新
					  collapsed:: true
						- 当路由器发现某个网段出现故障时，立刻发送路由更新包来通知邻居，而不用等到下一次发送路由更新包的时间
			- 链路状态
			- 层次路由
		- 互联网中的路由
-
-
-
-
- IPv4数据报的首部格式
- 固定部分（20字节）
- 版本
- 占4比特，表示IP协议的版本。
- 通信双方使用的IP协议的版本必须一致。目前广泛使用的IP协议版本号为4 (即IPv4) 。
- 首部长度
- 占4比特，表示IP数据报首部的长度。该字段的取值以4字节为单位。
- 最小十进制取值为5,表示IP数据报首部只有20字节固定部分;
- 最大十进制取值为15,表示IP数据报首部包含20字节固定部分和最大40字节可变部分。
- 区分服务
- 占8比特，用来获得更好的服务。
- 该字段在旧标准中叫作服务类型,但实际上一直没有被使用过。
- 1998年，因特网工程任务组IETF把这个字段改名为区分服务。
- 利用该字段的不同数值可提供不同等级的服务质量。
- 只有在使用区分服务时，该字段才起作用。一般情况下都不使用该字段。
- 总长度
- 占16比特，表示IP数据报的总长度(首部+数据载荷)。
- 最大取值为十进制的65535，以字节为单位。
- ![](https://api2.mubu.com/v3/document_image/e5da606d-8858-4af0-8a0a-b42a1f4ddce1-27042929.jpg)
- 标识，标志，片偏移
- 这三个字段共同用于IP数据报分片
- IP数据报将在数据链路层封装成帧
- 每一种数据链路层协议都规定了帧的数据载荷的最大长度，称为最大传输单元MTU。
- 如果某个IP数据报的总长度超过MTU时，将无法封装成帧，需要将原IP数据报分片为更小的IP数据报，再将各分片数据报封装成帧
- 图示
- ![](https://api2.mubu.com/v3/document_image/deafe2a3-b41c-411d-a89a-3093dcb5cc49-27042929.jpg)
- 标识
- 占16比特，属于同一个数据报的各分片数据报应该具有相同的标识。
- IP软件维持一个计数器,每产生一个数据报，计数器值加1,并将此值赋给标识字段。
- 标志
- 占3比特，各比特含义如下:
- DF位: 1表示不允许分片;0表示允许分片
- MF位: 1表示“后面还有分片”;0表示“这是最后-一个分片"
- 保留位:必须为0
- 片偏移
- 占13比特，指出分片数据报的数据载荷部分偏移其在原数据报的位置有多少个单位。
- 片偏移以8个字节为单位。
- 生存时间TTL
- 占8比特，最初以秒为单位，最大生存周期为255秒;路由器转发IP数据报时,将IP数据报首部中的该字段的值减去IP数据报在本路由器.上所耗费的时间，若不为0就转发，否则就丢弃。
- 现在以“跳数"为单位,路由器转发IP数据报时，将IP数据报首部中的该字段的值减1,若不为0就转发，否则就丢弃。
- 作用：防止IP数据报在网络中永久兜圈
- 协议
- 占8比特，指明IPv4数据报的数据部分是何种协议数据单元。
- 常用的-些协议和相应的协议字段值如下。
- ![](https://api2.mubu.com/v3/document_image/4ffec307-1e7d-49a7-82f2-2bd6e1984b21-27042929.jpg)
- 首部检验和
- 占16比特，用来检测首部在传输过程中是否出现差错。比CRC检验码简单,称为因特网检验和。
- IP数据报每经过一个路由器,路由器都要重新计算首部检验和，因为某些字段(生存时间、标志、片偏移等)的取值可能发生变化。
- 由于IP层本身并不提供可靠传输的服务，并且计算首部校验和是-项耗时的操作，因此在IPv6中,路由器不再计算首部校验和，从而更快转发IP数据报。
- 源IP地址和目的IP地址
- 各占32比特，用来填写发送该IP数据报的源主机的IP地址和接收该IP数据报的目的主机的IP地址。
- 可变部分（40字节）
- 可选字段
- 长度从1个字节到40个字节不等。用来支持排错、测量及安全等措施。
- 可选字段增加了IP数据报的功能，但这同时也使得IP数据报的首部长度成为可变的。这就增加了每一个路由器处理IP数据报的开销。实际上可选字段很少被使用。
- 填充字段
- 填充字段确保首部长度为4字节的整数倍。 使用全0进行填充。
- 图示
- ![](https://api2.mubu.com/v3/document_image/74b164b0-f628-44fe-87b3-b7c42ecc5dcc-27042929.jpg)
- 网际控制报文协议ICMP
- 定义
- 主机或路由器使用ICMP来发送差错报告报文和询问报文
- ICMP报文被封装在IP数据报中发送
- 差错报告报文
- 类型
- 终点不可达
- 当路由器或主机不能交付数据报时，就向源点发送终点不可达报文
- 具体可再根据ICMP的代码字段细分为目的网络不可达、目的主机不可达、目的协议不可达、目的端口不可达、目的网络未知、目的主机未知等13种错误
- 不知道如何转发路由<-当前路由器没有目的网段的路由记录，默认路由，目的主机特定路由
- ![](https://api2.mubu.com/v3/document_image/95814e05-55ce-49f3-afb4-ea1b7869f34c-27042929.jpg)
- 源点抑制
- 当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢
- ![](https://api2.mubu.com/v3/document_image/1c3788ce-f86a-457b-a2fd-1ce0a36789e4-27042929.jpg)
- ![](https://api2.mubu.com/v3/document_image/19efdfec-c4a4-4e5f-b7d1-94925268e560-27042929.jpg)
- 时间超过
- 当路由器收到一个目的IP地址不是自己的IP数据报，会将其生存时间TTL字段的值减1。
- 若结果不为0，则将该IP数据报转发出去;若结果为0，除丢弃该IP数据报外，还要向源点发送时间超过报文。
- ![](https://api2.mubu.com/v3/document_image/88505907-ad9f-4455-bb58-491c4a1c2adb-27042929.jpg)
- 另外，当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，也会向源点发送时间超过报文。
- 参数问题
- 当路由器或目的主机收到IP数据报后，根据其首部中的检验和字段发现首部在传输过程中出现了误码，就丢弃该数据报，并向源点发送参数问题报文。
- ![](https://api2.mubu.com/v3/document_image/63b5af05-e703-454d-8ef3-419d5b052fa9-27042929.jpg)
- 改变路由(重定向)
- 路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由)。
- ![](https://api2.mubu.com/v3/document_image/f930ecf5-4476-4629-9a90-4357a43be94c-27042929.jpg)
- 不应该发送报文的情况
- 对ICMP差错报告报文不再发送ICMP差错报告报文
- 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
- 对具有多播地址的数据报都不发送ICMP差错报告报文
- 对具有特殊地址(如127.0.0.0或0.0.0.0)的数据报不发送ICMP差错报告报文
- 询问报文
- 回送请求和回答
- ICMP回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。
- 这种询问报文用来测试目的站是否可达及了解其有关状态。
- 时间戳请求和回答
- ICMP时间戳请求报文是请某个主机或路由器回答当前的日期和时间。在ICMP时间戳回答报文中有一个32位的字段，其中写入的整数代表从1900年1月1日起到当前时刻一共有多少秒。
- 这种询问报文用来进行时钟同步和测量时间。
- 典型应用
- 分组网间探测PING(Packet lnterNet Groper)
- 用来测试主机或路由器间的连通性
- 应用层直接使用网际层的ICMP(没有通过运输层的TCP或UDP)
- 使用ICMP回送请求和回答报文
- 跟踪路由traceroute
- 用来测试IP数据报从源主机到达目的主机要经过哪些路由器
- Windows版本
- tracert命令
- 应用层直接使用网际层ICMP
- 使用了ICMP回送请求和回答报文以及差错报告报文
- Unix版本
- traceroute命令
- 在运输层使用UDP协议仅使用ICMP差错报告报文
- 原理
- 分别发送TTL=1，2，3...的ICMP回送请求报文的IP数据报
- ![](https://api2.mubu.com/v3/document_image/58600906-8f19-4dca-a396-f0d55d2d5ffc-27042929.jpg)
- 虚拟专用网VPN与网络地址转换NAT
- 第五章 运输层
- 概述
- 物理层，数据链路层，网络层->主机到主机的通信（异构网络）
- 但实际上在计算机网络中进行通信的真正实体是位于通信两端主机中的进程。
- 如何为运行在不同主机上的应用进程提供直接的通信服务是运输层的任务，运输层协议又称为端到端协议。
- 运输层向高层用户屏蔽了下面网络核心的细节(如网络拓扑、所采用的路由选择协议等)，它使应用进程看见的就好像是在两个运输层实体之间有一条端到端的逻辑通信信道。
- 根据应用需求的不同，因特网的运输层为应用层提供了两种不同的运输协议，即面向连接的TCP和无连接的UDP，这两种协议就是本章要讨论的主要内容。
- 图示
- ![](https://api2.mubu.com/v3/document_image/ba66f1f2-8b9e-4507-b154-2aa16dc67121-27042929.jpg)
- 端口号，复用，分用
- 端口号
- 运行在计算机上的进程使用进程标识符PID来标志。
- 因特网上的计算机并不是使用统一的操作系统，不同的操作系统(windows，Linux，Mac oS)又使用不同格式的进程标识符。
- 为了使运行不同操作系统的计算机的应用进程之间能够进行网络通信，就必须使用统一的方法对TCP/IP体系的应用进程进行标识。
- TCP/IP体系的运输层使用端口号来区分应用层的不同应用进程。
- 端口号使用16比特表示，取值范围0~65535;
- 熟知端口号:0~1023，IANA把这些端口号指派给了TCP/IP体系中最重要的一些应用协议，例如:FTP使用21/20,HTTP使用80，DNS使用53。
- 登记端口号:1024~49151，为没有熟知端口号的应用程序使用。使用这类端口号必须在IANA按照规定的手续登记，以防止重复。例如: Microsoft RDP微软远程桌面使用的端口是3389。
- 短暂端口号:49152~65535，留给客户进程选择暂时使用。当服务器进程收到客户进程的报文时，就知道了客户进程所使用的动态端口号。通信结束后，这个端口号可供其他客户进程以后使用。
- 端口号只具有本地意义，即端口号只是为了标识本计算机应用层中的各进程，在因特网中，不同计算机中的相同端口号是没有联系的。
- 发送方复用和接收方分用
- ![](https://api2.mubu.com/v3/document_image/fb705dc2-fab0-4524-b4c9-ae6bacdbffb7-27042929.jpg)
- TCP/IP中运输层熟知端口号
- ![](https://api2.mubu.com/v3/document_image/6c969bfd-eb31-4754-81f8-53585394b0ac-27042929.jpg)
- UDP与TCP对比
- 连接（逻辑上）
- UDP：无连接，随时发送数据
- TCP：面向连接，三次握手建立连接，数据传输，四次挥手释放连接
- 播
- UDP：单播（一对一），多播（一对多），广播（一对全）都支持
- TCP：可靠信道，仅支持单播
- 应用报文
- UDP：面向报文，UDP对应用进程交下来的报文既不合并也不拆分，而是保留这些报文的边界
- TCP：面向字节流
- 发送方：TCP把应用进程交付下来的数据块仅仅看作是一连串的，无结构的字节流。TCP并不知道放些待传送的字节流的含义，仅将他们编号并存放在发送缓存中，TCP根据发送策略，从发送缓存中提取一定数量的字节，构建TCP报文段并发送。
- 接收方：一方面从所接收到的TCP报文段中，取出数据载荷部分并存储在接收缓存中;一方面将接收缓存中的一些字节交付给应用进程
- TCP不保接收方应用进程所收到的数据块与发送方进程所发出的数据块具有对应大小的关系，但是字节流要完全一样。接收方的应用进程必须有能力识别收到的字节流，还原成有意义的应用层数据
- 在实际过程中，TCP是全双工通信
- 提供服务
- UDP：向上层提供无连接不可靠传输服务(适用于IP电话、视频会议等实时应用)
- TCP：向上层提供面向连接的可靠传输服务(适用于要求可靠传输的应用，例如文件传输)
- 数据报首部
- UDP：仅8字节
- ![](https://api2.mubu.com/v3/document_image/7880be08-e061-4ffb-b309-3e60fb0f3ff5-27042929.jpg)
- TCP：20-60字节
- ![](https://api2.mubu.com/v3/document_image/bf7f33fd-83d9-4dd1-b298-59e3efe65059-27042929.jpg)
- TCP流量控制
- 介绍
- 一般来说，我们总是希望数据传输得更快一些。
- 但如果发送方把数据发送得过快,接收方就可能来不及接收,这就会造成数据的丢失。
- 所谓流量控制(flow control)就是让发送方的发送速率不要太快，要让接收方来得及接收。
- 利用滑动窗口机制可以很方便地在TCP连接上实现对发送方的流量控制。
- 过程
- 动态rwnd
- TCP接收方利用自己的接收窗口的大小来限制发送方发送窗口的大小。
- ![](https://api2.mubu.com/v3/document_image/813a9ca3-8c4f-4a10-be92-ac0e82835de7-27042929.jpg)
- 死锁
- ![](https://api2.mubu.com/v3/document_image/e54fafa9-d931-4e2e-9921-cd40f725d9b2-27042929.jpg)
- 零窗口探测与持续计时器
- TCP发送方收到接收方的零窗口通知后，应启动持续计时器。持续计时器超时后,向接收方发送零窗口探测报文。
- ![](https://api2.mubu.com/v3/document_image/19f9fcd4-362e-4db4-a6ef-7c48827cc182-27042929.jpg)
- 注意
- 如果主机B此时的接收窗口仍然为0，那么金机B根本就制无去接受该报文段，又怎么会针对该报文段给主机A发回确认？
- 实际TCP规定,即时接收窗口为0，也必须接收零窗口探测报文段，确认报文段，以及携带有紧急数据的报文段
- 如果零窗口探测报文段丢失能否打破死锁？
- 可以，零窗口探测报文段也有重传计时器。
- TCP拥塞控制
- 介绍
- 在某段时间，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏.这种情况就叫做拥塞(congestion)。
- 在计算机网络中的链路容量（即带宽)、交换结点中的缓存和处理机等，都是网络的资源。
- 若出现拥塞而不进行控制，整个网络的吞吐量将随输入负荷的增大而下降
- ![](https://api2.mubu.com/v3/document_image/dada9b74-5212-4a13-a366-7781ac5a292a-27042929.jpg)
- 四种控制策略
- 假定条件
- 数据是单方向传送，而另一个方向只传送确认。
- 接收方总是有足够大的缓存空间，因而发送方发送窗口的大小由网络的拥塞程度来决定。
- 以最大报文段MSS的个数为讨论问题的单位，而不是以字节为单位。
- 慢开始（slow-start）
- cwnd初始值为1，每次扩大一倍
- “慢开始”是指一开始向网络注入的报文段少，并不是指拥塞窗口cwnd增长速度慢;
- 拥塞避免（congestion avoidance）
- 窗口大小到达ssthresh时，每次增大1
- “拥塞避免”并非指完全能够避免拥塞，而是指在拥塞避免阶段将拥塞窗口控制为按线性规律增长，使网络比较不容易出现拥塞;
- 快重传（fast retransmit）
- 所谓快重传，就是使发送方尽快进行重传，而不是等超时重传计时器超时再重传。
- 要求接收方不要等待自己发送数据时才进行捎带确认，而是要立即发送确认;
- 即使收到了失序的报文段也要立即发出对已收到的报文段的重复确认。
- 发送方一旦收到3个连续的重复确认，就将相应的报文段立即重传，而不是等该报文段的超时重传计时器超时再重传。
- 对于个别丢失的报文段，发送方不会出现超时重传，也就不会误认为出现了拥塞（进而降低拥塞窗口cwnd为1)。使用快重传可以使整个网络的吞吐量提高约20%。
- 快恢复（fast recovery）
- 发送方一旦收到3个重复确认，就知道现在只是丢失了个别的报文段。于是不启动慢开始算法，而执行快恢复算法;
- 发送方将慢开始门限ssthresh值和拥塞窗口cwnd值调整为当前窗口的一半;开始执行拥塞避免算法。
- 也有的快恢复实现是把快恢复开始时的拥塞窗口cwnd值再增大一些，即等于新的ssthresh + 3。
- 既然发送方收到3个重复的确认，就表明有3个数据报文段已经离开了网络;
- 这3个报文段不再消耗网络资源而是停留在接收方的接收缓存中;
- 可见现在网络中不是堆积了报文段而是减少了3个报文段。因此可以适当把拥塞窗口扩大些。
- 控制过程
- 拥塞窗口
- 发送方维护一个叫做拥塞窗口cwnd的状态变量，其值取决于网络的拥塞程度，并且动态变化。
- 拥塞窗口cwnd的维护原则:只要网络没有出现拥塞，拥塞窗口就再增大一些;但只要网络出现拥塞，拥塞窗口就减少一些。
- 判断出现网络拥塞的依据:没有按时收到应当到达的确认报文（即发生超时重传)。
- 发送窗口
- 发送方将拥塞窗口作为发送窗口swnd，即swnd = cwnd。
- 状态变量ssthresh
- 维护一个慢开始门限ssthresh状态变量:
- 当cwnd < ssthresh时，使用慢开始算法;
- 当cwnd > ssthresh时，停止使用慢开始算法而改用拥塞避免算法;
- 当cwnd = ssthresh时，既可使用慢开始算法，也可使用拥塞避免算法。
- 对于重传超时 TCP Tahoe 1988
- 慢开始+拥塞避免，cwnd直接减到1
- ![](https://api2.mubu.com/v3/document_image/be3e86d2-cf44-4421-ad32-0fb3bb908f67-27042929.jpg)
- 对于三次ACK TCP Reno 1990
- 慢开始和拥塞避免算法是1988年提出的TCP拥塞控制算法(TCP Tahoe版本)。
- 1990年又增加了两个新的拥塞控制算法(改进TCP的性能)，这就是快重传和快恢复（TCP Reno版本)。
- 有时，个别报文段会在网络中丢失，但实际上网络并未发生拥塞。
- 这将导致发送方超时重传，并误认为网络发生了拥塞;
- 发送方把拥塞窗口cwnd又设置为最小值1，并错误地启动慢开始算法，因而降低了传输效率。
- 图示
- 3次ACK
- ![](https://api2.mubu.com/v3/document_image/006151bf-4a8a-4063-a710-02fa6b0f197d-27042929.jpg)
- 超时+3次重复确认（此处Reno采取第一种）
- ![](https://api2.mubu.com/v3/document_image/ffd9a5aa-82e4-465f-85fd-582cdc82f015-27042929.jpg)
- TCP超时重传时间的选择
- 加权平均往返时间RTTs
- 不能直接使用某次测量得到的RTT样本来计算超时重传时间RTO。
- 利用每次测量得到的RTT样本，计算加权平均往返时间RTTs(又称为平滑的往返时间)。
- RTTs1, = RTT1,
- 新的RTTs= (1 - a)×旧的RTTs+a×新的RTT样本
- 在上式中，0 ≤a < l :
- 若α很接近于0，则新RTT样本对RTTs的影响不大;若α很接近于1，则新RTT样本对RTTs的影响较大;已成为建议标准的RFC6298推荐的α值为1/8，即0.125。
- 用这种方法得出的加权平均往返时间RTTs就比测量出的RTT值更加平滑。
- 显然，超时重传时间RTO应略大于加权平均往返时间RTTs。
- RTT偏差的加权平均RTTD
- RTO=RTTs+4 * RTTD
- ![](https://api2.mubu.com/v3/document_image/80bbd6c1-5555-4845-b31a-ed597fc2038a-27042929.jpg)
- Karn算法
- 针对出现超时重传时无法测准往返时间RTT的问题，Karn提出了一个算法:在计算加权平均往返时间RTTs时，只要报文段重传了，就不采用其往返时间RTT样本。也就是出现重传时，不重新计算RTTs，进而超时重传时间RTO也不会重新计算。
- 这又引起了新的问题。设想出现这样的情况:报文段的时延突然增大了很多，并且之后很长一段时间都会保持这种时延。因此在原来得出的重传时间内，不会收到确认报文段。于是就重传报文段。但根据Karn算法，不考虑重传的报文段的往返时间样本。这样，超时重传时间就无法更新。这会导致报文段反复被重传。
- 因此，要对Karn算法进行修正。方法是:报文段每重传一次，就把超时重传时间RTO增大一些。典型的做法是将新RTO的值取为旧RTO值的2倍。
- TCP可靠传输的实现
- TCP基于以字节为单位的滑动窗口来实现可靠传输
- 发送窗口
- 在前沿和后沿中间夹的是发送窗口
- 后沿
- 后沿前面是：已发送并收到确认可以删除的
- 移动情况
- 不动：没有收到新的确认
- 前移：收到了新的确认
- 前沿
- 前沿后面是：窗口还未到不允许发送
- 移动情况
- 通常是不断向前移动
- 不动
- 没有收到新的确认，对方通知的窗口大小也不变;
- 收到新确认但对方通知的窗口缩小，使发送窗口前沿正好不动;
- 向后收缩(对方通知的窗口缩小了，但TCP不赞成这样做)
- 状态标记
- 图示
- ![](https://api2.mubu.com/v3/document_image/d0207f5b-6e66-4912-8e34-bd6f62330380-27042929.jpg)
- 使用三个指针P1, P2, P3分别指向相应的字节序号
- 小于P1的是已发送并已收到确认的部分:
- 大于等于P3的是不允许发送的部分;
- P3-P1 =发送窗口的尺寸;
- P2-P1 =已发送但尚未收到确认的字节数;
- P3- P2 =允许发送但当前尚未发送的字节数(又称为可用窗口或有效窗口) ;
- 接收窗口
- ![](https://api2.mubu.com/v3/document_image/64d246cc-ce84-478c-93da-3667d8583252-27042929.jpg)
- 说明
- 虽然发送方的发送窗口是根据接收方的接收窗口设置的，但在同- -时刻，发送方的发送窗口并不总是和接收方的接收窗口-样大。
- 网络传送窗口值需要经历一-定的时间滞后，并且这个时间还是不确定的。
- 发送方还可能根据网络当时的拥塞情况适当减小自己的发送窗口尺寸。
- 对于不按序到达的数据应如何处理，TCP并无明确规定。
- 如果接收方把不按序到达的数据一律丢弃，那么接收窗口的管理将会比较简单，但这样做对网络资源的利用不利,因为发送方会重复传送较多的数据。
- TCP通常对不按序到达的数据是先临时存放在接收窗口中,等到字节流中所缺少的字节收到后，再按序交付上层的应用进程。
- TCP要求接收方必须有累积确认和捎带确认机制，这样可以减小传输开销。接收方可以在合适的时候发送确认，也可以在自己有数据要发送时把确认信息顺便捎带上。
- 接收方不应过分推迟发送确认， 否则会导致发送方不必要的超时重传，这反而浪费了网络的资源。TCP标准规定，确认推迟的时间不应超过0.5秒。若收到一连串具有最大长度的报文段,则必须每隔一个报文段就发送一个确认[RFC 1122]。
- 捎带确认实际上并不经常发生，因为大多数应用程序很少同时在两个方向上发送数据。
- TCP的通信是全双工通信。通信中的每一方都在发送和接收报文段。因此，每一方都有自己的发送窗口和接收窗口。在谈到这些窗口时，一定要弄清楚是哪一-方的窗口。
- TCP的运输连接管理
- 介绍
- TCP是面向连接的协议，它基于运输连接来传送TCP报文段。
- TCP运输连接的建立和释放是每一次面向连接的通信中必不可少的过程。
- TCP运输连接有以下三个阶段
- 建立TCP连接
- 数据传送
- 释放TCP连接
- TCP的运输连接管理就是使运输连接的建立和释放都能正常地进行。
- 连接建立
- TCP的连接建立要解决以下三个问题:
- 使TCP双方能够确知对方的存在;
- 使TCP双方能够协商一些参数(如最大窗口值、是否使用窗口扩大选项和时间戳选项以及服务质量等) ;
- 使TCP双方能够对运输实体资源(如缓存大小、连接表中的项目等)进行分配。
- 过程
- 图示![](https://api2.mubu.com/v3/document_image/0a35906e-a5d8-45a2-a0fc-0f8347e21608-27042929.jpg)
- TCP规定SYN置1的报文段不能携带数据，但要消耗掉一个序号
- 最后发送一个普通的TCP确认报文段，可以携带数据，如果不携带数据则不消耗序号，即下一个数据报文段的序号仍是x+1
- "两报文握手"不可行 - 半开连接
- 假设此时采用“二报文”，如果TCP连接请求在网络中滞留，引起超时重传，重传之后建立连接，传送数据，断开连接。此时服务端才接收到滞留的请求，则服务端会进入连接已建立状态，但客户端没有请求，一直关闭，所以服务端浪费很多资源
- ![](https://api2.mubu.com/v3/document_image/13c13436-856e-4108-8360-8cc3046022fc-27042929.jpg)
- 连接释放
- 过程
- 图示
- ![](https://api2.mubu.com/v3/document_image/130591c3-10b0-45a2-9289-7123b49713b3-27042929.jpg)
- TCP规定FIN置1的报文段即使不携带数据也要消耗掉一个序号
- MSL(Maximum Segment Lifetime)意思是最长报文段寿命，RFC793建议为2分钟。
- 时间等待状态的必要性
- 图示
- ![](https://api2.mubu.com/v3/document_image/80f8bb15-6521-4313-9b76-2d4091b8306b-27042929.jpg)
- 服务器可能由于最后的确认报文丢失而无法进入关闭状态
- 保活计时器
- TCP服务器进程每收到一次TCP客户进程的数据，就重新设置并启动保活计时器(2小时定时)。
- 若保活计时器定时周期内未收到TCP客户进程发来的数据，则当保活计时器到时后，TCP服务器进程就向TCP客户进程发送一个探测报文段，以后则每隔75秒钟发送一次。若一连发送10个探测报文段后仍无TCP客户进程的响应，TCP服务器进程就认为TCP客户进程所在主机出了故障,接着就关闭这个连接。
- TCP报文段的首部格式
- 介绍
- 为了实现可靠传输，TCP采用了面向字节流的方式。
- 但TCP在发送数据时，是从发送缓存取出一部分或全部字节并给其添加一一个首部使之成为TCP报文段后进行发送。
- 一个TCP报文段由首部和数据载荷两部分构成;
- TCP的全部功能都体现在它首部中各字段的作用。
- 格式
- 图示
- ![](https://api2.mubu.com/v3/document_image/6d23c1bd-6a06-4f3d-a625-005cf3c10f3d-27042929.jpg)
- 固定首部（20字节）
- 源端口
- 占16比特，写入源端口号，用来标识发送该TCP报文段的应用进程。
- 目的端口
- 占16比特，写入目的端口号，用来标识接收该TCP报文段的应用进程。
- 序号
- 占32比特,取值范围[0, 2*- 1],序号增加到最后一个后,下一个序号就又回到0。
- 指出本TCP报文段数据载荷的第一个字节的序号。
- 确认号
- 占32比特，取值范围[0, 2- 1],确认号增加到最后-一个后，下- -个确认号就又回到0。
- 指出期望收到对方下一个TCP报文段的数据载荷的第一个字节的序号,同时也是对之前收到的所有数据的确认。
- 若确认号=n，则表明到序号n-1为止的所有数据都已正确接收，期望接收序号为n的数据。
- 数据偏移
- 占4比特，并以4字节为单位。
- 用来指出TCP报文段的数据载荷部分的起始处距离TCP报文段的起始处有多远。
- 这个字段实际，上是指出了TCP报文段的首部长度。
- 首部固定长度为20字节，因此数据偏移字段的最小值为(0101)2
- 首部最大长度为60字节，因此数据偏移字段的最大值为(1111)2
- 保留
- 占6比特，保留为今后使用，但目前应置为0。
- 标志位
- 紧急标志位URG
- 取值为1时紧急指针字段有效;取值为0时紧急指针字段无效。
- 确认标志位ACK
- 取值为1时确认号字段才有效;取值为0时确认号字段无效。
- TCP规定，在连接建立后所有传送的TCP报文段都必须把ACK置1。
- 推送标志位PSH
- 接收方的TCP收到该标志位为1的报文段会尽快上交应用进程,而不必等到接收缓存都填满后再向上交付。
- 复位标志位RST
- 用来复位TCP连接。
- 当RST=1时，表明TCP连接出现了异常，必须释放连接，然后再重新建立连接。
- RST置1还用来拒绝一个非法的报文段或拒绝打开一个TCP连接。
- 同步标志位SYN
- 在TCP连接建立时用来同步序号。
- 终止标志位FIN
- 用来释放TCP连接。
- 窗口
- 占16比特，以字节为单位。指出发送本报文段的一方的接收窗口。
- 窗口值作为接收方让发送方设置其发送窗口的依据。
- 这是以接收方的接收能力来控制发送方的发送能力，称为流量控制。（实际上是流量窗口和接收窗口的小者）
- 校验和
- 占1 6比特,检查范围包括TCP报文段的首部和数据载荷两部分。
- 在计算校验和时，要在TCP报文段的前面加上12字节的伪首部。
- 紧急指针
- 占16比特，以字节为单位，用来指明紧急数据的长度。
- 当发送方有紧急数据时，可将紧急数据插队到发送缓存的最前面，并立刻封装到一个TCP报文段中进行发送。紧急指针会指出本报文段数据载荷部分包含了多长的紧急数据，紧急数据之后是普通数据。
- 扩展首部（最大40字节）
- 选项（长度可变）
- 最大报文段长度MSS选项: TCP报文段数据载荷部分的最大长度。
- 窗口扩大选项:为了扩大窗口(提高吞吐率)。
- 时间戳选项:
- 用来计算往返时间RTT
- 用于处理序号超范围的情况，又称为防止序号绕回PAWS。
- 选择确认选项
- 填充
- 填充:由于选项的长度可变，因此使用填充来确保报文段首部能被4整除(因为数据偏移字段,也就是首部长度字段，是以4字节为单位的)。
- 第六章 应用层
- 概述
- 客户-服务器方式和对等方式
- 动态主机配置协议DHCP
- 域名系统DNS
- 文件传输协议FTP
- 介绍
- 将某台计算机中的文件通过网络传送到可能相距很远的另一台计算机中，是一项基本的网络应用，即文件传送。
- 文件传送协议FTP (File Transfer Protocol)是因特网.上使用得最广泛的文件传送协议。
- FTP提供交互式的访问， 允许客户指明文件的类型与格式(如指明是否使用ASCII码) ,并允许文件具有存取权限(如访问文件的用户必须经过授权，并输入有效的口令)。
- FTP屏蔽 了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件。
- 在因特网发展的早期阶段，用FTP传送文件约占整个因特网的通信量的三分之一， 而由电子邮件和域名系统所产生的通信量还要小于FTP所产生的通信量。只是到了1995年，万维网WWW的通信量才首次超过了FTP。
- 应用
- FTP的常见用途是在计算机之间传输文件，尤其是用于批量传输文件。
- FTP的另一个常见用途是让网站设计者将构成网站内容的大量文件批量.上传到他们的Web服务器。
- 基本工作原理
- 两条连接
- 控制连接
- 用于传送控制命令的TCP连接
- 由客户端发起
- 服务器使用熟知端口21
- 在整个会话期间一直保持打开,用于传送FTP相关控制命令。
- 数据连接
- 用于传送数据的TCP连接
- 用于文件传输，在每次文件传输时才建立，传输结束就关闭。
- 两种模式
- 主动模式
- 服务器使用熟知端口号20
- 建立数据通道时，FTP服务器主动连接FTP客户
- 有数据要传输时，FTP客户通过命令通道告知FTP服务器来与自己的另一个临时端口号建立TCP连接，建立数据通道。
- 被动模式
- 建立数据通道时， FTP服务器被动等待FTP客户的连接
- 有数据要传输时，FTP客户通过命令通道告知FTP服务器开启某个临时端口被动等待TCP连接，建立数据通道。
- 电子邮件
- 介绍
- 电子邮件(E-mail) 是因特网.上最早流行的一种应用，并且仍然是当今因特网上最重要、最实用的应用之一。
- 传统的电话通信属于实时通信，存在以下两个缺点:
- 电话通信的主叫和被叫双方必须同时在场;
- 一些不是十分紧迫的电话也常常不必要地打断人们的工作或休息。
- 而电子邮件与邮政系统的寄信相似。
- 发件人将邮件发送到自己使用的邮件服务器;
- 发件人的邮件服务器将收到的邮件按其目的地址转发到收件人邮件服务器中的收件人邮箱;
- 收件人在方便的时候访问收件人邮件服务器中自己的邮箱,获取收到的电子邮件。
- 电子邮件使用方便、传递迅速而且费用低廉。它不仅可以传送文字信息，而且还可附上声音和图像。
- 由于电子邮件的广泛使用，现在许多国家已经正式取消了电报业务。在我国，电信局的电报业务也因电子邮件的普及而濒临消失。
- 电子邮件系统
- 电子邮件系统采用客户/服务器方式。
- 电子邮件系统的三个主要组成构件:用户代理，邮件服务器，以及电子邮件所需的协议。
- 用户代理是用户与电子邮件系统的接口，又称为电子邮件客户端软件。
- 邮件服务器是电子邮件系统的基础设施。因特网上所有的ISP都有邮件服务器,其功能是发送和接收邮件，同时还要负责维护用户的邮箱。
- 协议包括邮件发送协议(例如SMTP)和邮件读取协议(例如POP3, IMAP)。
- 过程
- ![](https://api2.mubu.com/v3/document_image/ecbb27f1-f3da-4a6a-afd8-bd27dcc3e3b6-27042929.jpg)
- 邮件发送协议SMTP
- 工作原理
- 发送方邮件服务器周期性地指描邮件缓存，如果发现有待转发的邮件，则发送方邮件服务器中的SMTP客户会与接收方邮件服务器中的SMTP服务器进行TCP连接，端口号25
- SMTP客户就可以基于这条TCP连接给SMTP服务器发送SMTP命令，SMTP服务器给SMTP客户返回应答。基于命令-应答方式。
- 14条SMTP命令
- 21种应答
- 工作过程
- 图示
- ![](https://api2.mubu.com/v3/document_image/ca2a210f-7d32-4ae5-8e5c-91af58c49317-27042929.jpg)
- 当TCP建立成功后，SMTP服务器会主动推送服务就绪应答给SMTP客户：220 + 描述信息
- 客户端收到应答后向服务器说明身份，告知自己SMTP服务器的域名：HELO [hnust.edu.cn](http://hnust.edu.cn/)
- 若SMTP服务器认为客户身份有效，则发回应答代码250，否则发挥其他代码，eg：421表示服务不可用
- 客户端收到应答后向告诉服务器邮件来自何方：MAIL FROM: <发件人地址>
- 若SMTP服务器认为合理，发回应答代码250;否则，发回其他错误代码
- 客户端告诉服务器邮件去往何地RCPT TO: <收件人地址>
- 若该邮箱存在，发回应答代码250;否则，发回其他错误代码
- 客户端告诉服务器自己准备发送邮件内容DATA
- 若准备好接收，发回应答代码354;否则，发回其他错误代码
- 客户端向服务器发送邮件内容<邮件内容>
- 客户端发送完邮件内容后，还要发送结束符
- 若收件成功，发回应答代码250;否则，发回其他错误代码
- 客户端向服务器请求断开连接QUIT
- 发回应答代码221表示接受请求并主动断开连接
- 电子邮件格式
- 信封
- 邮件系统将自动从首部提取所需信息并写在信封.上
- 内容
- 首部
- From：发件人地址
- To：收件人地址
- Cc：抄送人，可看可不看，可回可不回
- Subject：主题
- 主体
- 要发送的内容
- MIME
- SMTP协议只能传送ASCII码文本数据，不能传送可执行文件或其他的二进制对象。
- SMTP不能满足传送多媒体邮件(例如带有图片、音频或视频数据)的需要。并且许多其他非英语国家的文字(例如中文、俄文、甚至带有重音符号的法文或德文)也无法用SMTP传送。
- 为解决SMTP传送非ASCII码文本的问题，提出了多用途因特网邮件扩展MIME (Multipurpose Intermet Mail Extensions)：将非ASCII码转换为ASCII码进行传输，接收后再逆转换
- 增加了5个新的邮件首部字段，这些字段提供了有关邮件主体的信息。
- 定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行了标准化。
- 定义了传送编码，可对任何内容格式进行转换，而不会被邮件系统改变。
- 实际上，MIME不仅仅用于SMTP,也用于后来的同样面向ASCII字符的HTTP。
- 邮件读取协议POP3，IMAP
- 邮局协议POP (Post Office Protocol)，POP3是其第三个版本,是因特网正式标准。
- POP3使用熟知端口110
- 非常简单、功能有限的邮件读取协议。
- 用户只能以下载并删除方式或下载并保留方式从邮件服务器下载邮件到用户方计算机。
- 不允许用户在邮件服务器上管理自己的邮件。(例如创建文件夹， 对邮件进行分类管理等)。
- 因特网邮件访问协议IMAP (Internet Message Access Protocol)，IMAP4是其第四个版本，目前还只是因特网建议标准。
- IMAP4使用熟知端口143
- 功能比POP3强大的邮件读取协议。用户在自己的计算机上就可以操控邮件服务器中的邮箱，就像在本地操控一样,因此IMAP是一个联机协议。
- POP3和IMAP4都采用基于TCP连接的客户/服务器方式
- 基于万维网的电子邮件
- 通过浏览器登录(提供用户名和口令)邮件服务器万维网网站就可以撰写、收发、阅读和管理电子邮件。这种工作模式与IMAP很类似，不同的是用户计算机无需安装专门的用户代理程序，只需要使用通用的万维网浏览器。
- 邮件服务器网站通常都提供非常强大和方便的邮件管理功能，用户可以在邮件服务器网站.上管理和处理自己的邮件，而不需要将邮件下载到本地进行管理。
- 两种情况
- 使用相同的邮件服务器：HTTP
- ![](https://api2.mubu.com/v3/document_image/2fe012a9-5fbb-4cbf-a53e-1a7095a53fa4-27042929.jpg)
- 使用不同的邮件服务器：服务器和客户之间是HTTP，服务器之间是SMTP
- ![](https://api2.mubu.com/v3/document_image/c8c627d6-db7e-4b88-ab55-8d6536d43dbf-27042929.jpg)
- 万维网www